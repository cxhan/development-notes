---
title: 2023-02-08
---

## 前端监控数据上报方式对比

### 背景

去年的年终总结中，领导下了新指标，要在今年完成一个前端监控的项目。现在还在调研阶段，理所当然这个重任又落在了我身上，只能一步步来，最终实现较完美的前端监控平台综合解决方案。

那么下面就先从数据监控架构中，前端js-sdk来说一下，收集的信息应该如何上报服务端。

### 实现

**接口请求**

这种方式就跟平常我们写业务的时候请求的接口一样，就是一般的xhr或者fetch请求，相对比较简单，而且可以传递的数据量也很大，异步请求也不会阻塞页面正常渲染，但是会占用较多的客户端资源，而且如果跨域的话还要特殊处理(生产中一般都会跨域)

**图片打点**

图片打点是通过请求一个1*1px的图片（通常是gif，因为gif足够小，很省流量），然后将要上报的数据参数拼接到图片url之后，日志收集服务接到请求之后特殊处理生成日志供系统分析使用，这种方式的优势是占用客户端资源少，而且天然支持跨域，缺点就是图片请求是get的，上报的数据量有限制

**sendBeacon**

navigator.sendBeacon是一个新的API，它能异步以post方式发送数据到服务端，且不影响页面渲染，即使页面关闭，也不影响其数据的发送，浏览器自动进行调度，确保其可靠性。并且不受跨域限制，目前出IE之外几乎都支持该api，可以灵活的选择以接口请求方式或者图片打点来上报数据。

### 对比

根据以上实现方式的列举，我们总结如下：

| 方式/对比    | 接口请求                   | 图片打点                                  | sendBeacon                 |
| ------------ | -------------------------- | ----------------------------------------- | -------------------------- |
| 资源占用大小 | 大                         | 小                                        | 中                         |
| 是否阻塞页面 | 异步不阻塞，同步请求会阻塞 | 不阻塞                                    | 不阻塞                     |
| 传输数据大小 | 大                         | 小（一般不超过8KB，视浏览器具体限制而定） | 中等（chrome最多也就64KB） |
| 跨域支持     | 需要特殊处理               | 支持                                      | 支持                       |
| 安全性       | 一般                       | 较高                                      | 一般                       |
| 兼容性       | 高                         | 高                                        | IE不支持                   |
| 难易程度     | 简单                       | 比较复杂                                  | 视具体上报的方式而定       |



### 结论

综上，三种上报数据的方式，都不是完美的，但是相对分析数据没有那么多的情况下，一般还是会选择图片打点的方式，毕竟占用资源少（升流量）、支持跨域、兼容性高的有点也是其他两种方式无可比拟的。

<a href="https://github.com/cxhan" target="_blank"><img src="../../assets/logo.png" style="max-width: 600px;margin: 0 auto;display: block;"/></a>
